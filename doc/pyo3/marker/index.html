<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="generator" content="rustdoc"><meta name="description" content="Fundamental properties of objects tied to the Python interpreter."><meta name="keywords" content="rust, rustlang, rust-lang, marker"><title>pyo3::marker - Rust</title><link rel="preload" as="font" type="font/woff2" crossorigin href="../../SourceSerif4-Regular.ttf.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../../FiraSans-Regular.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../../FiraSans-Medium.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../../SourceCodePro-Regular.ttf.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../../SourceSerif4-Bold.ttf.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../../SourceCodePro-Semibold.ttf.woff2"><link rel="stylesheet" type="text/css" href="../../normalize.css"><link rel="stylesheet" type="text/css" href="../../rustdoc.css" id="mainThemeStyle"><link rel="stylesheet" type="text/css" href="../../ayu.css" disabled><link rel="stylesheet" type="text/css" href="../../dark.css" disabled><link rel="stylesheet" type="text/css" href="../../light.css" id="themeStyle"><script id="default-settings" ></script><script src="../../storage.js"></script><script src="../../crates.js"></script><script defer src="../../main.js"></script>
    <noscript><link rel="stylesheet" href="../../noscript.css"></noscript><link rel="alternate icon" type="image/png" href="../../favicon-16x16.png"><link rel="alternate icon" type="image/png" href="../../favicon-32x32.png"><link rel="icon" type="image/svg+xml" href="../../favicon.svg"></head><body class="rustdoc mod"><!--[if lte IE 11]><div class="warning">This old browser is unsupported and will most likely display funky things.</div><![endif]--><nav class="mobile-topbar"><button class="sidebar-menu-toggle">&#9776;</button><a class="sidebar-logo" href="../../pyo3/index.html"><div class="logo-container"><img class="rust-logo" src="../../rust-logo.svg" alt="logo"></div>
        </a><h2 class="location"></h2>
    </nav>
    <nav class="sidebar"><a class="sidebar-logo" href="../../pyo3/index.html"><div class="logo-container"><img class="rust-logo" src="../../rust-logo.svg" alt="logo"></div>
        </a><h2 class="location"><a href="#">Module marker</a></h2><div class="sidebar-elems"><section><div class="block"><ul><li><a href="#structs">Structs</a></li><li><a href="#traits">Traits</a></li></ul></div></section><div id="sidebar-vars" data-name="marker" data-ty="mod" data-relpath="./"></div><script defer src="./sidebar-items.js"></script></div></nav><main><div class="width-limiter"><div class="sub-container"><a class="sub-logo-container" href="../../pyo3/index.html"><img class="rust-logo" src="../../rust-logo.svg" alt="logo"></a><nav class="sub"><div class="theme-picker hidden"><button id="theme-picker" aria-label="Pick another theme!" aria-haspopup="menu" title="themes"><img width="22" height="22" alt="Pick another theme!" src="../../brush.svg"></button><div id="theme-choices" role="menu"></div></div><form class="search-form"><div class="search-container"><span></span><input class="search-input" name="search" autocomplete="off" spellcheck="false" placeholder="Click or press ‚ÄòS‚Äô to search, ‚Äò?‚Äô for more options‚Ä¶" type="search"><button type="button" id="help-button" title="help">?</button><a id="settings-menu" href="../../settings.html" title="settings"><img width="22" height="22" alt="Change settings" src="../../wheel.svg"></a></div></form></nav></div><section id="main-content" class="content"><div class="main-heading">
    <h1 class="fqn"><span class="in-band">Module <a href="../index.html">pyo3</a>::<wbr><a class="mod" href="#">marker</a><button id="copy-path" onclick="copy_path(this)" title="Copy item path to clipboard"><img src="../../clipboard.svg" width="19" height="18" alt="Copy item path"></button></span></h1><span class="out-of-band"><a class="srclink" href="../../src/pyo3/marker.rs.html#5-1018">source</a> ¬∑ <a id="toggle-all-docs" href="javascript:void(0)" title="collapse all docs">[<span class="inner">&#x2212;</span>]</a></span></div><details class="rustdoc-toggle top-doc" open><summary class="hideme"><span>Expand description</span></summary><div class="docblock"><p>Fundamental properties of objects tied to the Python interpreter.</p>
<p>The Python interpreter is not threadsafe. To protect the Python interpreter in multithreaded
scenarios there is a global lock, the <em>global interpreter lock</em> (hereafter referred to as <em>GIL</em>)
that must be held to safely interact with Python objects. This is why in PyO3 when you acquire
the GIL you get a <a href="struct.Python.html" title="Python"><code>Python</code></a> marker token that carries the <em>lifetime</em> of holding the GIL and all
borrowed references to Python objects carry this lifetime as well. This will statically ensure
that you can never use Python objects after dropping the lock - if you mess this up it will be
caught at compile time and your program will fail to compile.</p>
<p>It also supports this pattern that many extension modules employ:</p>
<ul>
<li>Drop the GIL, so that other Python threads can acquire it and make progress themselves</li>
<li>Do something independently of the Python interpreter, like IO, a long running calculation or
awaiting a future</li>
<li>Once that is done, reacquire the GIL</li>
</ul>
<p>That API is provided by <a href="struct.Python.html#method.allow_threads" title="Python::allow_threads"><code>Python::allow_threads</code></a> and enforced via the <a href="trait.Ungil.html" title="Ungil"><code>Ungil</code></a> bound on the
closure and the return type. This is done by relying on the <a href="https://doc.rust-lang.org/1.62.1/core/marker/trait.Send.html" title="Send"><code>Send</code></a> auto trait. <code>Ungil</code> is
defined as the following:</p>

<div class="example-wrap"><pre class="rust rust-example-rendered"><code><span class="kw">pub</span> <span class="kw">unsafe</span> <span class="kw">trait</span> <span class="ident">Ungil</span> {}

<span class="kw">unsafe</span> <span class="kw">impl</span><span class="op">&lt;</span><span class="ident">T</span>: <span class="ident">Send</span><span class="op">&gt;</span> <span class="ident">Ungil</span> <span class="kw">for</span> <span class="ident">T</span> {}</code></pre></div>
<p>We piggy-back off the <code>Send</code> auto trait because it is not possible to implement custom auto
traits on stable Rust. This is the solution which enables it for as many types as possible while
making the API usable.</p>
<p>In practice this API works quite well, but it comes with some drawbacks:</p>
<h3 id="drawbacks"><a href="#drawbacks">Drawbacks</a></h3>
<p>There is no reason to prevent <code>!Send</code> types like <a href="https://doc.rust-lang.org/1.62.1/alloc/rc/struct.Rc.html"><code>Rc</code></a> from crossing the closure. After all,
<a href="struct.Python.html#method.allow_threads" title="Python::allow_threads"><code>Python::allow_threads</code></a> just lets other Python threads run - it does not itself launch a new
thread.</p>

<div class='information'><div class='tooltip compile_fail'>‚ìò</div></div><div class="example-wrap"><pre class="rust rust-example-rendered compile_fail"><code><span class="kw">use</span> <span class="ident">pyo3::prelude</span>::<span class="kw-2">*</span>;
<span class="kw">use</span> <span class="ident">std::rc::Rc</span>;

<span class="kw">fn</span> <span class="ident">main</span>() {
    <span class="ident">Python::with_gil</span>(<span class="op">|</span><span class="ident">py</span><span class="op">|</span> {
        <span class="kw">let</span> <span class="ident">rc</span> <span class="op">=</span> <span class="ident">Rc::new</span>(<span class="number">5</span>);

        <span class="ident">py</span>.<span class="ident">allow_threads</span>(<span class="op">|</span><span class="op">|</span> {
            <span class="comment">// This would actually be fine...</span>
            <span class="macro">println!</span>(<span class="string">&quot;{:?}&quot;</span>, <span class="kw-2">*</span><span class="ident">rc</span>);
        });
    });
}</code></pre></div>
<p>Because we are using <code>Send</code> for something it‚Äôs not quite meant for, other code that
(correctly) upholds the invariants of <a href="https://doc.rust-lang.org/1.62.1/core/marker/trait.Send.html" title="Send"><code>Send</code></a> can cause problems.</p>
<p><a href="https://docs.rs/send_wrapper/latest/send_wrapper/struct.SendWrapper.html"><code>SendWrapper</code></a> is one of those. Per its documentation:</p>
<blockquote>
<p>A wrapper which allows you to move around non-Send-types between threads, as long as you
access the contained value only from within the original thread and make sure that it is
dropped from within the original thread.</p>
</blockquote>
<p>This will ‚Äúwork‚Äù to smuggle Python references across the closure, because we‚Äôre not actually
doing anything with threads:</p>

<div class="example-wrap"><pre class="rust rust-example-rendered"><code><span class="kw">use</span> <span class="ident">pyo3::prelude</span>::<span class="kw-2">*</span>;
<span class="kw">use</span> <span class="ident">pyo3::types::PyString</span>;
<span class="kw">use</span> <span class="ident">send_wrapper::SendWrapper</span>;

<span class="ident">Python::with_gil</span>(<span class="op">|</span><span class="ident">py</span><span class="op">|</span> {
    <span class="kw">let</span> <span class="ident">string</span> <span class="op">=</span> <span class="ident">PyString::new</span>(<span class="ident">py</span>, <span class="string">&quot;foo&quot;</span>);

    <span class="kw">let</span> <span class="ident">wrapped</span> <span class="op">=</span> <span class="ident">SendWrapper::new</span>(<span class="ident">string</span>);

    <span class="ident">py</span>.<span class="ident">allow_threads</span>(<span class="op">|</span><span class="op">|</span> {
        <span class="comment">// üí• Unsound! üí•</span>
        <span class="kw">let</span> <span class="ident">smuggled</span>: <span class="kw-2">&amp;</span><span class="ident">PyString</span> <span class="op">=</span> <span class="kw-2">*</span><span class="ident">wrapped</span>;
        <span class="macro">println!</span>(<span class="string">&quot;{:?}&quot;</span>, <span class="ident">smuggled</span>);
    });
});</code></pre></div>
<p>For now the answer to that is ‚Äúdon‚Äôt do that‚Äù.</p>
<h2 id="a-proper-implementation-using-an-auto-trait"><a href="#a-proper-implementation-using-an-auto-trait">A proper implementation using an auto trait</a></h2>
<p>However on nightly Rust and when PyO3‚Äôs <code>nightly</code> feature is
enabled, <code>Ungil</code> is defined as the following:</p>

<div class="example-wrap"><pre class="rust rust-example-rendered"><code><span class="attribute">#![<span class="ident">feature</span>(<span class="ident">auto_traits</span>, <span class="ident">negative_impls</span>)]</span>

<span class="kw">pub</span> <span class="kw">unsafe</span> <span class="ident">auto</span> <span class="kw">trait</span> <span class="ident">Ungil</span> {}

<span class="comment">// It is unimplemented for the `Python` struct and Python objects.</span>
<span class="kw">impl</span> <span class="op">!</span><span class="ident">Ungil</span> <span class="kw">for</span> <span class="ident">Python</span><span class="op">&lt;</span><span class="lifetime">&#39;_</span><span class="op">&gt;</span> {}
<span class="kw">impl</span> <span class="op">!</span><span class="ident">Ungil</span> <span class="kw">for</span> <span class="ident">ffi::PyObject</span> {}

<span class="comment">// `Py` wraps it in  a safe api, so this is OK</span>
<span class="kw">unsafe</span> <span class="kw">impl</span> <span class="op">&lt;</span><span class="ident">T</span><span class="op">&gt;</span> <span class="ident">Ungil</span> <span class="kw">for</span> <span class="ident">Py</span><span class="op">&lt;</span><span class="ident">T</span><span class="op">&gt;</span> {}</code></pre></div>
<p>With this feature enabled, the above two examples will start working and not working, respectively.</p>
</div></details><h2 id="structs" class="small-section-header"><a href="#structs">Structs</a></h2>
<div class="item-table"><div class="item-row"><div class="item-left module-item"><a class="struct" href="struct.Python.html" title="pyo3::marker::Python struct">Python</a></div><div class="item-right docblock-short"><p>A marker token that represents holding the GIL.</p>
</div></div></div><h2 id="traits" class="small-section-header"><a href="#traits">Traits</a></h2>
<div class="item-table"><div class="item-row"><div class="item-left module-item"><a class="trait" href="trait.Ungil.html" title="pyo3::marker::Ungil trait">Ungil</a></div><div class="item-right docblock-short"><p>Types that are safe to access while the GIL is not held.</p>
</div></div></div></section></div></main><div id="rustdoc-vars" data-root-path="../../" data-current-crate="pyo3" data-themes="ayu,dark,light" data-resource-suffix="" data-rustdoc-version="1.62.1 (e092d0b6b 2022-07-16)" ></div>
</body></html>