<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="generator" content="rustdoc"><meta name="description" content="PyO3’s interior mutability primitive."><meta name="keywords" content="rust, rustlang, rust-lang, pycell"><title>pyo3::pycell - Rust</title><link rel="preload" as="font" type="font/woff2" crossorigin href="../../SourceSerif4-Regular.ttf.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../../FiraSans-Regular.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../../FiraSans-Medium.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../../SourceCodePro-Regular.ttf.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../../SourceSerif4-Bold.ttf.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../../SourceCodePro-Semibold.ttf.woff2"><link rel="stylesheet" type="text/css" href="../../normalize.css"><link rel="stylesheet" type="text/css" href="../../rustdoc.css" id="mainThemeStyle"><link rel="stylesheet" type="text/css" href="../../ayu.css" disabled><link rel="stylesheet" type="text/css" href="../../dark.css" disabled><link rel="stylesheet" type="text/css" href="../../light.css" id="themeStyle"><script id="default-settings" ></script><script src="../../storage.js"></script><script src="../../crates.js"></script><script defer src="../../main.js"></script>
    <noscript><link rel="stylesheet" href="../../noscript.css"></noscript><link rel="alternate icon" type="image/png" href="../../favicon-16x16.png"><link rel="alternate icon" type="image/png" href="../../favicon-32x32.png"><link rel="icon" type="image/svg+xml" href="../../favicon.svg"></head><body class="rustdoc mod"><!--[if lte IE 11]><div class="warning">This old browser is unsupported and will most likely display funky things.</div><![endif]--><nav class="mobile-topbar"><button class="sidebar-menu-toggle">&#9776;</button><a class="sidebar-logo" href="../../pyo3/index.html"><div class="logo-container"><img class="rust-logo" src="../../rust-logo.svg" alt="logo"></div>
        </a><h2 class="location"></h2>
    </nav>
    <nav class="sidebar"><a class="sidebar-logo" href="../../pyo3/index.html"><div class="logo-container"><img class="rust-logo" src="../../rust-logo.svg" alt="logo"></div>
        </a><h2 class="location"><a href="#">Module pycell</a></h2><div class="sidebar-elems"><section><div class="block"><ul><li><a href="#structs">Structs</a></li></ul></div></section><div id="sidebar-vars" data-name="pycell" data-ty="mod" data-relpath="./"></div><script defer src="./sidebar-items.js"></script></div></nav><main><div class="width-limiter"><div class="sub-container"><a class="sub-logo-container" href="../../pyo3/index.html"><img class="rust-logo" src="../../rust-logo.svg" alt="logo"></a><nav class="sub"><div class="theme-picker hidden"><button id="theme-picker" aria-label="Pick another theme!" aria-haspopup="menu" title="themes"><img width="22" height="22" alt="Pick another theme!" src="../../brush.svg"></button><div id="theme-choices" role="menu"></div></div><form class="search-form"><div class="search-container"><span></span><input class="search-input" name="search" autocomplete="off" spellcheck="false" placeholder="Click or press ‘S’ to search, ‘?’ for more options…" type="search"><button type="button" id="help-button" title="help">?</button><a id="settings-menu" href="../../settings.html" title="settings"><img width="22" height="22" alt="Change settings" src="../../wheel.svg"></a></div></form></nav></div><section id="main-content" class="content"><div class="main-heading">
    <h1 class="fqn"><span class="in-band">Module <a href="../index.html">pyo3</a>::<wbr><a class="mod" href="#">pycell</a><button id="copy-path" onclick="copy_path(this)" title="Copy item path to clipboard"><img src="../../clipboard.svg" width="19" height="18" alt="Copy item path"></button></span></h1><span class="out-of-band"><a class="srclink" href="../../src/pyo3/pycell.rs.html#1-930">source</a> · <a id="toggle-all-docs" href="javascript:void(0)" title="collapse all docs">[<span class="inner">&#x2212;</span>]</a></span></div><details class="rustdoc-toggle top-doc" open><summary class="hideme"><span>Expand description</span></summary><div class="docblock"><p>PyO3’s interior mutability primitive.</p>
<p>Rust has strict aliasing rules - you can either have any number of immutable (shared) references or one mutable
reference. Python’s ownership model is the complete opposite of that - any Python object
can be referenced any number of times, and mutation is allowed from any reference.</p>
<p>PyO3 deals with these differences by employing the <a href="https://doc.rust-lang.org/book/ch15-05-interior-mutability.html" title="RefCell&lt;T&gt; and the Interior Mutability Pattern - The Rust Programming Language">Interior Mutability</a>
pattern. This requires that PyO3 enforces the borrowing rules and it has two mechanisms for
doing so:</p>
<ul>
<li>Statically it can enforce threadsafe access with the <a href="../marker/struct.Python.html"><code>Python&lt;'py&gt;</code></a> token.
All Rust code holding that token, or anything derived from it, can assume that they have
safe access to the Python interpreter’s state. For this reason all the native Python objects
can be mutated through shared references.</li>
<li>However, methods and functions in Rust usually <em>do</em> need <code>&amp;mut</code> references. While PyO3 can
use the <a href="../marker/struct.Python.html"><code>Python&lt;'py&gt;</code></a> token to guarantee thread-safe access to them, it cannot
statically guarantee uniqueness of <code>&amp;mut</code> references. As such those references have to be tracked
dynamically at runtime, using <a href="struct.PyCell.html" title="PyCell"><code>PyCell</code></a> and the other types defined in this module. This works
similar to std’s <a href="https://doc.rust-lang.org/1.62.1/core/cell/struct.RefCell.html"><code>RefCell</code></a> type.</li>
</ul>
<h2 id="when-not-to-use-pycell"><a href="#when-not-to-use-pycell">When <em>not</em> to use PyCell</a></h2>
<p>Usually you can use <code>&amp;mut</code> references as method and function receivers and arguments, and you
won’t need to use <a href="struct.PyCell.html" title="PyCell"><code>PyCell</code></a> directly:</p>

<div class="example-wrap"><pre class="rust rust-example-rendered"><code><span class="kw">use</span> <span class="ident">pyo3::prelude</span>::<span class="kw-2">*</span>;

<span class="attribute">#[<span class="ident">pyclass</span>]</span>
<span class="kw">struct</span> <span class="ident">Number</span> {
    <span class="ident">inner</span>: <span class="ident">u32</span>,
}

<span class="attribute">#[<span class="ident">pymethods</span>]</span>
<span class="kw">impl</span> <span class="ident">Number</span> {
    <span class="kw">fn</span> <span class="ident">increment</span>(<span class="kw-2">&amp;mut</span> <span class="self">self</span>) {
        <span class="self">self</span>.<span class="ident">inner</span> <span class="op">+</span><span class="op">=</span> <span class="number">1</span>;
    }
}</code></pre></div>
<p>The <a href="../attr.pymethods.html"><code>#[pymethods]</code></a> proc macro will generate this wrapper function (and more),
using <a href="struct.PyCell.html" title="PyCell"><code>PyCell</code></a> under the hood:</p>

<div class='information'><div class='tooltip ignore'>ⓘ</div></div><div class="example-wrap"><pre class="rust rust-example-rendered ignore"><code><span class="comment">// This function is exported to Python.</span>
<span class="kw">unsafe</span> <span class="kw">extern</span> <span class="string">&quot;C&quot;</span> <span class="kw">fn</span> <span class="ident">__wrap</span>(<span class="ident">slf</span>: <span class="kw-2">*mut</span> <span class="ident">PyObject</span>, <span class="ident">_args</span>: <span class="kw-2">*mut</span> <span class="ident">PyObject</span>) -&gt; <span class="kw-2">*mut</span> <span class="ident">PyObject</span> {
    <span class="ident">pyo3::callback::handle_panic</span>(<span class="op">|</span><span class="ident">py</span><span class="op">|</span> {
        <span class="kw">let</span> <span class="ident">cell</span>: <span class="kw-2">&amp;</span><span class="ident">PyCell</span><span class="op">&lt;</span><span class="ident">Number</span><span class="op">&gt;</span> <span class="op">=</span> <span class="ident">py</span>.<span class="ident">from_borrowed_ptr</span>(<span class="ident">slf</span>);
        <span class="kw">let</span> <span class="kw-2">mut</span> <span class="ident">_ref</span>: <span class="ident">PyRefMut</span><span class="op">&lt;</span><span class="ident">Number</span><span class="op">&gt;</span> <span class="op">=</span> <span class="ident">cell</span>.<span class="ident">try_borrow_mut</span>()<span class="question-mark">?</span>;
        <span class="kw">let</span> <span class="ident">slf</span>: <span class="kw-2">&amp;mut</span> <span class="ident">Number</span> <span class="op">=</span> <span class="kw-2">&amp;mut</span> <span class="ident">_ref</span>;
        <span class="ident">pyo3::callback::convert</span>(<span class="ident">py</span>, <span class="ident">Number::increment</span>(<span class="ident">slf</span>))
    })
}</code></pre></div>
<h2 id="when-to-use-pycell"><a href="#when-to-use-pycell">When to use PyCell</a></h2><h3 id="using-pyclasses-from-rust"><a href="#using-pyclasses-from-rust">Using pyclasses from Rust</a></h3>
<p>However, we <em>do</em> need <a href="struct.PyCell.html" title="PyCell"><code>PyCell</code></a> if we want to call its methods from Rust:</p>

<div class="example-wrap"><pre class="rust rust-example-rendered"><code><span class="ident">Python::with_gil</span>(<span class="op">|</span><span class="ident">py</span><span class="op">|</span> {
    <span class="kw">let</span> <span class="ident">n</span> <span class="op">=</span> <span class="ident">Py::new</span>(<span class="ident">py</span>, <span class="ident">Number</span> { <span class="ident">inner</span>: <span class="number">0</span> })<span class="question-mark">?</span>;

    <span class="comment">// We borrow the guard and then dereference</span>
    <span class="comment">// it to get a mutable reference to Number</span>
    <span class="kw">let</span> <span class="kw-2">mut</span> <span class="ident">guard</span>: <span class="ident">PyRefMut</span><span class="op">&lt;</span><span class="lifetime">&#39;_</span>, <span class="ident">Number</span><span class="op">&gt;</span> <span class="op">=</span> <span class="ident">n</span>.<span class="ident">as_ref</span>(<span class="ident">py</span>).<span class="ident">borrow_mut</span>();
    <span class="kw">let</span> <span class="ident">n_mutable</span>: <span class="kw-2">&amp;mut</span> <span class="ident">Number</span> <span class="op">=</span> <span class="kw-2">&amp;mut</span> <span class="kw-2">*</span><span class="ident">guard</span>;

    <span class="ident">n_mutable</span>.<span class="ident">increment</span>();

    <span class="comment">// To avoid panics we must dispose of the</span>
    <span class="comment">// `PyRefMut` before borrowing again.</span>
    <span class="ident">drop</span>(<span class="ident">guard</span>);

    <span class="kw">let</span> <span class="ident">n_immutable</span> : <span class="kw-2">&amp;</span><span class="ident">Number</span> <span class="op">=</span> <span class="kw-2">&amp;</span><span class="ident">n</span>.<span class="ident">as_ref</span>(<span class="ident">py</span>).<span class="ident">borrow</span>();
    <span class="macro">assert_eq!</span>(<span class="ident">n_immutable</span>.<span class="ident">inner</span>, <span class="number">1</span>);

    <span class="prelude-val">Ok</span>(())
})</code></pre></div>
<h3 id="dealing-with-possibly-overlapping-mutable-references"><a href="#dealing-with-possibly-overlapping-mutable-references">Dealing with possibly overlapping mutable references</a></h3>
<p>It is also necessary to use <a href="struct.PyCell.html" title="PyCell"><code>PyCell</code></a> if you can receive mutable arguments that may overlap.
Suppose the following function that swaps the values of two <code>Number</code>s:</p>

<div class="example-wrap"><pre class="rust rust-example-rendered"><code><span class="attribute">#[<span class="ident">pyfunction</span>]</span>
<span class="kw">fn</span> <span class="ident">swap_numbers</span>(<span class="ident">a</span>: <span class="kw-2">&amp;mut</span> <span class="ident">Number</span>, <span class="ident">b</span>: <span class="kw-2">&amp;mut</span> <span class="ident">Number</span>) {
    <span class="ident">std::mem::swap</span>(<span class="kw-2">&amp;mut</span> <span class="ident">a</span>.<span class="ident">inner</span>, <span class="kw-2">&amp;mut</span> <span class="ident">b</span>.<span class="ident">inner</span>);
}</code></pre></div>
<p>When users pass in the same <code>Number</code> as both arguments, one of the mutable borrows will
fail and raise a <code>RuntimeError</code>:</p>
<div class="example-wrap"><pre class="language-text"><code>&gt;&gt;&gt; a = Number()
&gt;&gt;&gt; swap_numbers(a, a)
Traceback (most recent call last):
  File &quot;&lt;stdin&gt;&quot;, line 1, in &lt;module&gt;
  RuntimeError: Already borrowed</code></pre></div>
<p>It is better to write that function like this:</p>

<div class="example-wrap"><pre class="rust rust-example-rendered"><code><span class="attribute">#[<span class="ident">pyfunction</span>]</span>
<span class="kw">fn</span> <span class="ident">swap_numbers</span>(<span class="ident">a</span>: <span class="kw-2">&amp;</span><span class="ident">PyCell</span><span class="op">&lt;</span><span class="ident">Number</span><span class="op">&gt;</span>, <span class="ident">b</span>: <span class="kw-2">&amp;</span><span class="ident">PyCell</span><span class="op">&lt;</span><span class="ident">Number</span><span class="op">&gt;</span>) {
    <span class="comment">// Check that the pointers are unequal</span>
    <span class="kw">if</span> <span class="op">!</span><span class="ident">a</span>.<span class="ident">is</span>(<span class="ident">b</span>) {
        <span class="ident">std::mem::swap</span>(<span class="kw-2">&amp;mut</span> <span class="ident">a</span>.<span class="ident">borrow_mut</span>().<span class="ident">inner</span>, <span class="kw-2">&amp;mut</span> <span class="ident">b</span>.<span class="ident">borrow_mut</span>().<span class="ident">inner</span>);
    } <span class="kw">else</span> {
        <span class="comment">// Do nothing - they are the same object, so don&#39;t need swapping.</span>
    }
}</code></pre></div>
<p>See the <a href="https://pyo3.rs/latest/class.html#pycell-and-interior-mutability" title="PyCell and interior mutability">guide</a> for more information.</p>
</div></details><h2 id="structs" class="small-section-header"><a href="#structs">Structs</a></h2>
<div class="item-table"><div class="item-row"><div class="item-left module-item"><a class="struct" href="struct.PyBorrowError.html" title="pyo3::pycell::PyBorrowError struct">PyBorrowError</a></div><div class="item-right docblock-short"><p>An error type returned by <a href="struct.PyCell.html#method.try_borrow" title="PyCell::try_borrow"><code>PyCell::try_borrow</code></a>.</p>
</div></div><div class="item-row"><div class="item-left module-item"><a class="struct" href="struct.PyBorrowMutError.html" title="pyo3::pycell::PyBorrowMutError struct">PyBorrowMutError</a></div><div class="item-right docblock-short"><p>An error type returned by <a href="struct.PyCell.html#method.try_borrow_mut" title="PyCell::try_borrow_mut"><code>PyCell::try_borrow_mut</code></a>.</p>
</div></div><div class="item-row"><div class="item-left module-item"><a class="struct" href="struct.PyCell.html" title="pyo3::pycell::PyCell struct">PyCell</a></div><div class="item-right docblock-short"><p>A container type for (mutably) accessing <a href="../pyclass/trait.PyClass.html" title="PyClass"><code>PyClass</code></a> values</p>
</div></div><div class="item-row"><div class="item-left module-item"><a class="struct" href="struct.PyRef.html" title="pyo3::pycell::PyRef struct">PyRef</a></div><div class="item-right docblock-short"><p>A wrapper type for an immutably borrowed value from a <a href="struct.PyCell.html" title="PyCell"><code>PyCell</code></a><code>&lt;T&gt;</code>.</p>
</div></div><div class="item-row"><div class="item-left module-item"><a class="struct" href="struct.PyRefMut.html" title="pyo3::pycell::PyRefMut struct">PyRefMut</a></div><div class="item-right docblock-short"><p>A wrapper type for a mutably borrowed value from a<a href="struct.PyCell.html" title="PyCell"><code>PyCell</code></a><code>&lt;T&gt;</code>.</p>
</div></div></div></section></div></main><div id="rustdoc-vars" data-root-path="../../" data-current-crate="pyo3" data-themes="ayu,dark,light" data-resource-suffix="" data-rustdoc-version="1.62.1 (e092d0b6b 2022-07-16)" ></div>
</body></html>